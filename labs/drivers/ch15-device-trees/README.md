
# Chapter 15 - Device trees



## Device Tree compiler

To install the device tree compiler:

```
 $ sudo apt install device-tree-compiler
```

To compile dts to dtb:

```
 $ dtc -I dts -O dtb -o tpu_hw.dtb  tpu_hw.dts
```

To convert dtb to dts:

```
 $ dtc -I dtb -O dts -o test.dts tpu_hw.dtb
 $ cat test.dts
```

## How to generate the DTB used by QEMU

To understand device trees, we could write one from scratch, however, we can
try to leverage the one that qemu generates automatically for the `-machine virt`
machine.

To generate the dtb with the memory and cpu configuration passed to
`qemu-system-aarch64`, we add the parameter `-machine virt,dumpdtb=qemu_virt.dtb`:

```
$ sudo qemu-system-aarch64 \
	-m 2048 \
    -cpu cortex-a72 \
    -machine virt,dumpdtb=qemu_virt.dtb \
    -nographic \
    -smp 1 \
    -hda $hda \
    -kernel $kernel \
    -append "console=ttyAMA0 root=/dev/vda oops=panic panic_on_warn=1 panic=-1 debug earlyprintk=serial" \
    -object rng-random,filename=/dev/urandom,id=rng0 \
    -device virtio-rng-pci,rng=rng0 \
    -device virtio-net-pci,netdev=eth0 \
    -netdev user,id=eth0,hostfwd=tcp::8022-:22

# qemu_virt.dtb file was generated by the previous command.
$ dtb=/home/parallels/Development/tools/linux-stable/qemu_virt.dtb

# Pass the dtb qemu_virt.dtb to qemu-system-aarch64.
$ sudo qemu-system-aarch64 \
	-m 2048 \
    -cpu cortex-a72 \
    -machine virt \
    -nographic \
    -smp 1 \
    -dtb $dtb \
    -hda $hda \
    -kernel $kernel \
    -append "console=ttyAMA0 root=/dev/vda oops=panic panic_on_warn=1 panic=-1 debug earlyprintk=serial" \
    -object rng-random,filename=/dev/urandom,id=rng0 \
    -device virtio-rng-pci,rng=rng0 \
    -device virtio-net-pci,netdev=eth0 \
    -netdev user,id=eth0,hostfwd=tcp::8022-:22

WARNING: Image format was not specified for '/home/parallels/Development/tools/buildroot/output/images/rootfs.ext2' and probing guessed raw.
         Automatically detecting the format is dangerous for raw images, write operations on block 0 will be restricted.
         Specify the 'raw' format explicitly to remove the restrictions.
```

`WARNING:` After adding the DTB, `qemu-system-aarch64` halts. Due to this,
another alternative is to build the kernel for a different board that is also
supported by qemu and buildroot.

## Check which boards are supported by kernel and buildroot

To check the boards supported by the kernel:

```
 $ git clone git://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git linux-stable
 $ cd linux-stable/
 $ git checkout -b linux-6.6.y origin/linux-6.6.y

 $ find . -name *defconfig | grep arm
./arch/arm/configs/multi_v4t_defconfig
./arch/arm/configs/pxa_defconfig
...
./arch/arm/configs/vexpress_defconfig
...
./arch/arm/configs/omap2plus_defconfig
```

To check the boards supported by qemu

```
 $ qemu-system-aarch64 --machine help
Supported machines are:
akita                Sharp SL-C1000 (Akita) PDA (PXA270)
ast2500-evb          Aspeed AST2500 EVB (ARM1176)
ast2600-evb          Aspeed AST2600 EVB (Cortex A7)
borzoi               Sharp SL-C3100 (Borzoi) PDA (PXA270)
canon-a1100          Canon PowerShot A1100 IS
cheetah              Palm Tungsten|E aka. Cheetah PDA (OMAP310)

versatileab          ARM Versatile/AB (ARM926EJ-S)
versatilepb          ARM Versatile/PB (ARM926EJ-S)
vexpress-a15         ARM Versatile Express for Cortex-A15
vexpress-a9          ARM Versatile Express for Cortex-A9
virt-2.10            QEMU 2.10 ARM Virtual Machine
..
xlnx-zcu102          Xilinx ZynqMP ZCU102 board with 4xA53s and 2xR5Fs based on the value of smp
z2                   Zipit Z2 (PXA27x)
```

The board `vexpress-a9` is a good candidate to use because it is supported by
the kernel `vexpress_defconfig` too.

```
 $ find . -name *defconfig | grep vexpress
./arch/arm/configs/vexpress_defconfig
```

## Install and configure buildroot

We will install buildroot with support for `Cortex A9` processor:

```
 # The library below might be required.
 # sudo apt install libc6-i386
 $ git clone git://git.buildroot.net/buildroot buildroot
 $ cd buildroot/
 $ git log --oneline | grep linux-headers

 # Use the configuration file:
 # ch15-device-trees/configs/buildroot_vexpress_config.txt
 $ make menuconfig
 $ make
 $ ls output/images/
rootfs.cpio  rootfs.cpio.gz  rootfs.ext2  rootfs.tar
```

## Build Linux Kernel

```
 $ sudo apt install gcc-arm-linux-gnueabi
 $ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- mrproper
 $ make ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- vexpress_defconfig

 $ make -j40 ARCH=arm CROSS_COMPILE=arm-linux-gnueabi-
  CALL    scripts/checksyscalls.sh
  Kernel: arch/arm/boot/Image is ready
  Kernel: arch/arm/boot/zImage is ready
 $ make -j40 ARCH=arm CROSS_COMPILE=arm-linux-gnueabi- dtbs
 $ find arch/arm -name *.dtb
arch/arm/boot/dts/arm/vexpress-v2p-ca15_a7.dtb
arch/arm/boot/dts/arm/vexpress-v2p-ca9.dtb
arch/arm/boot/dts/arm/vexpress-v2p-ca15-tc1.dtb
arch/arm/boot/dts/arm/vexpress-v2p-ca5s.dtb
```

## Compile the driver and include it in the rootfs

Compile the kernel module:

```
 $ cd ch15-device-trees/driver
 $ make KERNEL_DIR=<path to kernel>/linux-stable
```

Unzip the `rootfs.copio.gz` file that buildroot generated:

```
 $ cd ./buildroot/output/images
 $ mkdir custom_cpio
 $ cd custom_cpio/
 $ gzip -cd ../rootfs.cpio.gz | cpio -idmv
 ```

When we boot the kernel with the dtb and `initrd` option, the rootfs with `cpio`
format is required.

Include the `tpu-hw-driver.ko` module in the rootfs:

```
 $ cp ch15-device-trees/driver/*.ko custom_cpio/root

 # Package the content of custom_cpio into a cpio file.
 $ cd custom_cpio
 $ find . | sudo cpio -H newc -ov --owner root:root > ../custom_rootfs.cpio
 $ cd ..
 $ gzip custom_rootfs.cpio
```

## Compile custom DTS

The custom DTS for the vexpress board to compile is:
`ch15-device-trees/configs/custom_vexpress-v2p-ca9.dts`

```
 $ cd ch15-device-trees/configs/
 $ dtc -I dts -O dtb -o custom_vexpress-v2p-ca9.dtb custom_vexpress-v2p-ca9.dts
```

## Run qemu

```
 $ dtb=./linux-stable/arch/arm/boot/dts/arm/vexpress-v2p-ca9.dtb
 $ kernel=./linux-stable/arch/arm/boot/zImage
 $ initrd=./buildroot/output/images/rootfs.cpio.gz

 $ sudo QEMU_AUDIO_DRV=none qemu-system-arm \
	-m 256M \
    -nographic \
    -machine vexpress-a9 \
    -kernel $kernel \
    -dtb $dtb \
    -initrd $initrd \
    -append "console=ttyAMA0,115200 rdinit=/sbin/init" \
    -object rng-random,filename=/dev/urandom,id=rng0 \
    -device virtio-net-device,netdev=eth0 \
    -netdev user,id=eth0,hostfwd=tcp::8022-:22
```

## insmod tpu_hw_driver.ko

```
 qemu $ insmod tpu_hw_driver.ko
tpu_hw_driver: loading out-of-tree module taints kernel.
tpu_hw_driver: tpu_hw_probe: Probing device
tpu_hw_driver: tpu_hw_probe: algos-props = logistic regression,random forests
tpu_hw_driver: tpu_hw_probe: default-state = off
tpu_hw_driver: tpu_hw_probe: iterations = 44
```

## Print device tree

```
 # dtc -I fs /sys/firmware/

 # ls /sys/firmware/devicetree/base/
#address-cells                 memory-controller@100e1000
#size-cells                    memory@60000000
aliases                        model
arm,hbi                        name
arm,vexpress,site              pmu
bus@40000000                   reserved-memory
cache-controller@1e00a000      scu@1e000000
chosen                         timer@100e4000
clcd@10020000                  timer@1e000600
compatible                     tpu_hw_dummy
cpus                           virtio_mmio@10013000
dcc                            virtio_mmio@10013200
hsb@e0000000                   virtio_mmio@10013400
interrupt-controller@1e001000  virtio_mmio@10013600
interrupt-parent               watchdog@100e5000
memory-controller@100e0000     watchdog@1e000620

# cat /sys/firmware/devicetree/base/compatible
arm,vexpress,v2p-ca9arm,vexpress

# ls /sys/firmware/devicetree/base/chosen/
bootargs            linux,initrd-start
linux,initrd-end    name

# cat /sys/firmware/devicetree/base/chosen/bootargs
console=ttyAMA0,115200 rdinit=/sbin/init
```

We can see the TPU configuration in:

```
# tree /sys/firmware/devicetree/base/tpu_hw_dummy/
/sys/firmware/devicetree/base/tpu_hw_dummy/
|-- algos-props
|-- compatible
|-- default-state
|-- iterations
`-- name

# for node in /sys/firmware/devicetree/base/tpu_hw_dummy/*; \
     do echo $node; cat $node; echo ""; done

/sys/firmware/devicetree/base/tpu_hw_dummy/algos-props
logistic regression,random forests
/sys/firmware/devicetree/base/tpu_hw_dummy/compatible
tpu_hw,dummytpu_hw,board
/sys/firmware/devicetree/base/tpu_hw_dummy/default-state
off
/sys/firmware/devicetree/base/tpu_hw_dummy/iterations
,
/sys/firmware/devicetree/base/tpu_hw_dummy/name
tpu_hw_dummy
```

To print the 32-bit `cell values`, we can use:

```
# hexdump -C /sys/firmware/devicetree/base/tpu_hw_dummy/iterations
00000000  00 00 00 2c                                       |...,|
00000004
```

